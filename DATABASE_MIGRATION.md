# 📊 Esquema Completo de Base de Datos - Catálogo Mundo Cuotas

Este documento contiene toda la información necesaria para migrar y recrear la base de datos completa del sistema de catálogo y financiación.

## 📋 Índice

1. [Extensiones y Configuración](#extensiones-y-configuración)
2. [Tablas Principales](#tablas-principales)
3. [Índices](#índices)
4. [Funciones y Triggers](#funciones-y-triggers)
5. [Row Level Security (RLS)](#row-level-security-rls)
6. [Políticas de Seguridad](#políticas-de-seguridad)
7. [Storage Buckets](#storage-buckets)
8. [Datos de Ejemplo](#datos-de-ejemplo)

---

## 🔧 Extensiones y Configuración

```sql
-- Habilitar extensiones necesarias
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

---

## 📊 Tablas Principales

### 1. **categorias**
Tabla para las categorías de productos.

```sql
CREATE TABLE public.categorias (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    descripcion text not null,
    
    constraint categorias_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación (automática)
- `descripcion` (TEXT): Nombre de la categoría

---

### 2. **marcas**
Tabla para las marcas de productos.

```sql
CREATE TABLE public.marcas (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    descripcion text not null,
    logo text null,
    
    constraint marcas_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación (automática)
- `descripcion` (TEXT): Nombre de la marca
- `logo` (TEXT, NULLABLE): URL del logo de la marca

---

### 3. **productos**
Tabla principal de productos con múltiples campos de imagen y configuraciones.

```sql
CREATE TABLE public.productos (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    descripcion text not null,
    descripcion_detallada text null,
    precio numeric(10,2) not null,
    imagen text null,
    imagen_2 text null,
    imagen_3 text null,
    imagen_4 text null,
    imagen_5 text null,
    destacado boolean default false,
    activo boolean default true,
    aplica_todos_plan boolean default false,
    aplica_solo_categoria boolean default false,
    aplica_plan_especial boolean default false,
    fk_id_categoria bigint null,
    fk_id_marca bigint null,
    
    constraint productos_pkey primary key (id),
    constraint productos_fk_id_categoria_fkey foreign key (fk_id_categoria) 
        references public.categorias (id) on delete set null,
    constraint productos_fk_id_marca_fkey foreign key (fk_id_marca) 
        references public.marcas (id) on delete set null
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación (automática)
- `descripcion` (TEXT): Nombre del producto
- `descripcion_detallada` (TEXT, NULLABLE): Descripción extendida con HTML
- `precio` (NUMERIC): Precio del producto
- `imagen` (TEXT, NULLABLE): URL de imagen principal
- `imagen_2` a `imagen_5` (TEXT, NULLABLE): URLs de imágenes adicionales
- `destacado` (BOOLEAN): Producto destacado
- `activo` (BOOLEAN): Producto activo/inactivo
- `aplica_todos_plan` (BOOLEAN): Se incluye en todos los planes automáticamente
- `aplica_solo_categoria` (BOOLEAN): Solo se incluye según categoría
- `aplica_plan_especial` (BOOLEAN): Requiere configuración especial
- `fk_id_categoria` (BIGINT, FK): Referencia a categoría
- `fk_id_marca` (BIGINT, FK): Referencia a marca

---

### 4. **planes_financiacion**
Tabla de planes de financiación.

```sql
CREATE TABLE public.planes_financiacion (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    updated_at timestamp with time zone not null default now(),
    nombre text not null,
    cuotas integer not null,
    recargo_porcentual numeric(5,2) null,
    recargo_fijo numeric(10,2) null,
    monto_minimo numeric(10,2) not null,
    monto_maximo numeric(10,2) null,
    anticipo_minimo numeric(5,2) null,
    anticipo_minimo_fijo numeric(10,2) null,
    activo boolean default true,
    
    constraint planes_financiacion_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `updated_at` (TIMESTAMPTZ): Fecha de última actualización
- `nombre` (TEXT): Nombre del plan
- `cuotas` (INTEGER): Número de cuotas
- `recargo_porcentual` (NUMERIC, NULLABLE): Recargo en porcentaje
- `recargo_fijo` (NUMERIC, NULLABLE): Recargo fijo en pesos
- `monto_minimo` (NUMERIC): Monto mínimo para aplicar el plan
- `monto_maximo` (NUMERIC, NULLABLE): Monto máximo del plan
- `anticipo_minimo` (NUMERIC, NULLABLE): Anticipo mínimo en porcentaje
- `anticipo_minimo_fijo` (NUMERIC, NULLABLE): Anticipo mínimo fijo
- `activo` (BOOLEAN): Plan activo/inactivo

---

### 5. **planes_categorias**
Tabla intermedia para relación muchos-a-muchos entre planes y categorías.

```sql
CREATE TABLE public.planes_categorias (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_plan bigint not null,
    fk_id_categoria bigint not null,
    
    constraint planes_categorias_pkey primary key (id),
    constraint planes_categorias_fk_id_plan_fkey foreign key (fk_id_plan) 
        references public.planes_financiacion (id) on delete cascade,
    constraint planes_categorias_fk_id_categoria_fkey foreign key (fk_id_categoria) 
        references public.categorias (id) on delete cascade,
    constraint planes_categorias_unique unique (fk_id_plan, fk_id_categoria)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `fk_id_plan` (BIGINT, FK): Referencia a plan de financiación
- `fk_id_categoria` (BIGINT, FK): Referencia a categoría

---

### 6. **productos_planes**
Tabla para productos configurados manualmente en planes específicos.

```sql
CREATE TABLE public.productos_planes (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_producto bigint not null,
    fk_id_plan bigint not null,
    activo boolean default true,
    destacado boolean default false,
    
    constraint productos_planes_pkey primary key (id),
    constraint productos_planes_fk_id_producto_fkey foreign key (fk_id_producto) 
        references public.productos (id) on delete cascade,
    constraint productos_planes_fk_id_plan_fkey foreign key (fk_id_plan) 
        references public.planes_financiacion (id) on delete cascade,
    constraint productos_planes_unique unique (fk_id_producto, fk_id_plan)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `fk_id_producto` (BIGINT, FK): Referencia a producto
- `fk_id_plan` (BIGINT, FK): Referencia a plan de financiación
- `activo` (BOOLEAN): Relación activa/inactiva
- `destacado` (BOOLEAN): Producto destacado en el plan

---

### 7. **productos_planes_default**
Tabla de respaldo para asociaciones automáticas por reglas.

```sql
CREATE TABLE public.productos_planes_default (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_producto bigint not null,
    fk_id_plan bigint not null,
    activo boolean default true,
    
    constraint productos_planes_default_pkey primary key (id),
    constraint productos_planes_default_fk_id_producto_fkey foreign key (fk_id_producto) 
        references public.productos (id) on delete cascade,
    constraint productos_planes_default_fk_id_plan_fkey foreign key (fk_id_plan) 
        references public.planes_financiacion (id) on delete cascade,
    constraint productos_planes_default_unique unique (fk_id_producto, fk_id_plan)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `fk_id_producto` (BIGINT, FK): Referencia a producto
- `fk_id_plan` (BIGINT, FK): Referencia a plan de financiación
- `activo` (BOOLEAN): Asociación activa/inactiva

---

### 8. **zonas**
Tabla para zonas geográficas.

```sql
CREATE TABLE public.zonas (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    nombre text null,
    
    constraint zonas_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `nombre` (TEXT, NULLABLE): Nombre de la zona

---

### 9. **configuracion**
Tabla de configuración general del sistema.

```sql
CREATE TABLE public.configuracion (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    telefono text null,
    
    constraint configuracion_pkey primary key (id)
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `telefono` (TEXT, NULLABLE): Teléfono general

---

### 10. **configuracion_zonas**
Tabla de configuración específica por zona.

```sql
CREATE TABLE public.configuracion_zonas (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    fk_id_zona bigint not null,
    telefono text not null,
    
    constraint configuracion_zonas_pkey primary key (id),
    constraint configuracion_zonas_fk_id_zona_fkey foreign key (fk_id_zona) 
        references public.zonas (id) on delete cascade
);
```

**Campos:**
- `id` (BIGINT, PK): Identificador único autoincremental
- `created_at` (TIMESTAMPTZ): Fecha de creación
- `fk_id_zona` (BIGINT, FK): Referencia a zona
- `telefono` (TEXT): Teléfono específico de la zona

---

## 📈 Índices

### Índices de rendimiento para productos
```sql
-- Índices para productos
CREATE INDEX productos_activo_idx ON public.productos (activo);
CREATE INDEX productos_destacado_idx ON public.productos (destacado);
CREATE INDEX productos_fk_id_categoria_idx ON public.productos (fk_id_categoria);
CREATE INDEX productos_fk_id_marca_idx ON public.productos (fk_id_marca);
CREATE INDEX productos_aplica_todos_plan_idx ON public.productos (aplica_todos_plan);
CREATE INDEX productos_aplica_solo_categoria_idx ON public.productos (aplica_solo_categoria);
CREATE INDEX productos_aplica_plan_especial_idx ON public.productos (aplica_plan_especial);

-- Índices para imágenes (solo cuando no son nulas)
CREATE INDEX productos_imagen_idx ON public.productos (imagen) WHERE imagen IS NOT NULL;
CREATE INDEX productos_imagen_2_idx ON public.productos (imagen_2) WHERE imagen_2 IS NOT NULL;
CREATE INDEX productos_imagen_3_idx ON public.productos (imagen_3) WHERE imagen_3 IS NOT NULL;
CREATE INDEX productos_imagen_4_idx ON public.productos (imagen_4) WHERE imagen_4 IS NOT NULL;
CREATE INDEX productos_imagen_5_idx ON public.productos (imagen_5) WHERE imagen_5 IS NOT NULL;
```

### Índices para planes de financiación
```sql
CREATE INDEX planes_financiacion_activo_idx ON public.planes_financiacion (activo);
CREATE INDEX planes_financiacion_cuotas_idx ON public.planes_financiacion (cuotas);
CREATE INDEX planes_financiacion_monto_minimo_idx ON public.planes_financiacion (monto_minimo);
```

### Índices para tablas relacionales
```sql
-- Planes-Categorías
CREATE INDEX planes_categorias_fk_id_plan_idx ON public.planes_categorias (fk_id_plan);
CREATE INDEX planes_categorias_fk_id_categoria_idx ON public.planes_categorias (fk_id_categoria);

-- Productos-Planes
CREATE INDEX productos_planes_fk_id_producto_idx ON public.productos_planes (fk_id_producto);
CREATE INDEX productos_planes_fk_id_plan_idx ON public.productos_planes (fk_id_plan);
CREATE INDEX productos_planes_activo_idx ON public.productos_planes (activo);
CREATE INDEX productos_planes_destacado_idx ON public.productos_planes (destacado);

-- Productos-Planes-Default
CREATE INDEX productos_planes_default_fk_id_producto_idx ON public.productos_planes_default (fk_id_producto);
CREATE INDEX productos_planes_default_fk_id_plan_idx ON public.productos_planes_default (fk_id_plan);
CREATE INDEX productos_planes_default_activo_idx ON public.productos_planes_default (activo);

-- Configuración Zonas
CREATE INDEX configuracion_zonas_fk_id_zona_idx ON public.configuracion_zonas (fk_id_zona);
```

---

## ⚙️ Funciones y Triggers

### Función para actualizar timestamp automáticamente
```sql
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

### Triggers para actualizar updated_at automáticamente
```sql
-- Trigger para planes_financiacion
CREATE TRIGGER update_planes_financiacion_updated_at 
    BEFORE UPDATE ON public.planes_financiacion
    FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
```

---

## 🔒 Row Level Security (RLS)

### Habilitar RLS en todas las tablas
```sql
-- Habilitar RLS en todas las tablas principales
ALTER TABLE public.categorias ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.marcas ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.planes_financiacion ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.planes_categorias ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos_planes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.productos_planes_default ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.zonas ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.configuracion ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.configuracion_zonas ENABLE ROW LEVEL SECURITY;
```

---

## 🛡️ Políticas de Seguridad

### Políticas para todas las tablas (acceso público para lectura)
```sql
-- CATEGORIAS
CREATE POLICY "Permitir acceso completo a categorias" 
    ON public.categorias FOR ALL USING (true);

-- MARCAS
CREATE POLICY "Permitir acceso completo a marcas" 
    ON public.marcas FOR ALL USING (true);

-- PRODUCTOS
CREATE POLICY "Permitir acceso completo a productos" 
    ON public.productos FOR ALL USING (true);

-- PLANES_FINANCIACION
CREATE POLICY "Permitir acceso completo a planes_financiacion" 
    ON public.planes_financiacion FOR ALL USING (true);

-- PLANES_CATEGORIAS
CREATE POLICY "Permitir acceso completo a planes_categorias" 
    ON public.planes_categorias FOR ALL USING (true);

-- PRODUCTOS_PLANES
CREATE POLICY "Permitir acceso completo a productos_planes" 
    ON public.productos_planes FOR ALL USING (true);

-- PRODUCTOS_PLANES_DEFAULT
CREATE POLICY "Permitir acceso completo a productos_planes_default" 
    ON public.productos_planes_default FOR ALL USING (true);

-- ZONAS
CREATE POLICY "Permitir acceso completo a zonas" 
    ON public.zonas FOR ALL USING (true);

-- CONFIGURACION
CREATE POLICY "Permitir acceso completo a configuracion" 
    ON public.configuracion FOR ALL USING (true);

-- CONFIGURACION_ZONAS
CREATE POLICY "Permitir acceso completo a configuracion_zonas" 
    ON public.configuracion_zonas FOR ALL USING (true);
```

---

## 📦 Storage Buckets

### Bucket de imágenes
```sql
-- Crear bucket de imágenes
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'imagenes',
    'imagenes',
    true,
    5242880, -- 5MB en bytes
    ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
) ON CONFLICT (id) DO NOTHING;
```

### Políticas de Storage
```sql
-- Política para subir archivos (público)
CREATE POLICY "Permitir subir imágenes públicamente" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'imagenes');

-- Política para ver archivos (público)
CREATE POLICY "Permitir ver imágenes públicamente" ON storage.objects
FOR SELECT USING (bucket_id = 'imagenes');

-- Política para actualizar archivos (público)
CREATE POLICY "Permitir actualizar imágenes públicamente" ON storage.objects
FOR UPDATE USING (bucket_id = 'imagenes');

-- Política para eliminar archivos (público)
CREATE POLICY "Permitir eliminar imágenes públicamente" ON storage.objects
FOR DELETE USING (bucket_id = 'imagenes');
```

### Estructura de carpetas en Storage
```
Bucket: imagenes/
├── productos/          # Imágenes de productos
│   ├── abc123.jpg
│   ├── def456.png
│   └── ...
└── logos/              # Logos de marcas
    ├── marca1.png
    ├── marca2.jpg
    └── ...
```

---

## 📄 Comentarios en Tablas

```sql
-- Comentarios para documentación
COMMENT ON TABLE public.categorias IS 'Categorías de productos disponibles';
COMMENT ON TABLE public.marcas IS 'Marcas de productos con logos opcionales';
COMMENT ON TABLE public.productos IS 'Catálogo principal de productos con múltiples imágenes';
COMMENT ON TABLE public.planes_financiacion IS 'Planes de financiación con diferentes configuraciones';
COMMENT ON TABLE public.planes_categorias IS 'Relación muchos-a-muchos entre planes y categorías';
COMMENT ON TABLE public.productos_planes IS 'Productos asignados manualmente a planes específicos';
COMMENT ON TABLE public.productos_planes_default IS 'Asociaciones automáticas por reglas de negocio';
COMMENT ON TABLE public.zonas IS 'Zonas geográficas para configuración regional';
COMMENT ON TABLE public.configuracion IS 'Configuración general del sistema';
COMMENT ON TABLE public.configuracion_zonas IS 'Configuración específica por zona geográfica';
```

---

## 📊 Datos de Ejemplo

### Categorías de ejemplo
```sql
INSERT INTO public.categorias (descripcion) VALUES
    ('Smartphones'),
    ('Tablets'),
    ('Laptops'),
    ('Accesorios'),
    ('Audio'),
    ('Gaming');
```

### Marcas de ejemplo
```sql
INSERT INTO public.marcas (descripcion, logo) VALUES
    ('Apple', 'https://ejemplo.com/logos/apple.png'),
    ('Samsung', 'https://ejemplo.com/logos/samsung.png'),
    ('Xiaomi', 'https://ejemplo.com/logos/xiaomi.png'),
    ('Lenovo', 'https://ejemplo.com/logos/lenovo.png'),
    ('Sony', 'https://ejemplo.com/logos/sony.png');
```

### Planes de financiación de ejemplo
```sql
INSERT INTO public.planes_financiacion (nombre, cuotas, recargo_porcentual, monto_minimo, activo) VALUES
    ('Plan 3 Cuotas', 3, 0.00, 50000.00, true),
    ('Plan 6 Cuotas', 6, 15.00, 100000.00, true),
    ('Plan 12 Cuotas', 12, 25.00, 200000.00, true),
    ('Plan 18 Cuotas', 18, 35.00, 300000.00, true),
    ('Plan 24 Cuotas', 24, 45.00, 500000.00, true);
```

---

## 🚀 Orden de Migración

Para migrar la base de datos, ejecutar en este orden:

1. **Extensiones y configuración básica**
2. **Tablas base** (categorias, marcas)
3. **Tablas principales** (productos, planes_financiacion)
4. **Tablas relacionales** (planes_categorias, productos_planes, etc.)
5. **Tablas de configuración** (zonas, configuracion, configuracion_zonas)
6. **Índices**
7. **Funciones y triggers**
8. **RLS y políticas de seguridad**
9. **Storage buckets y políticas**
10. **Datos de ejemplo** (opcional)

---

## ⚠️ Notas Importantes

- **RLS está habilitado** con políticas permisivas para desarrollo
- **Todas las tablas usan BIGINT** como clave primaria autoincremental
- **Storage público** configurado para imágenes hasta 5MB
- **Múltiples imágenes por producto** (hasta 5 imágenes)
- **Descripción detallada soporta HTML** para formato enriquecido
- **Sistema de planes flexible** con recargas porcentuales o fijas
- **Asociaciones automáticas y manuales** entre productos y planes
- **Configuración por zonas** para soporte regional

---

📅 **Fecha de creación:** $(date)  
🔄 **Versión:** 1.0  
👤 **Generado por:** Claude Code Assistant